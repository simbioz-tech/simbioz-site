#!/bin/bash

# ะกะบัะธะฟั ัะฐะทะฒะตัััะฒะฐะฝะธั Telegram ะฑะพัะฐ ะดะปั CI/CD

echo "๐ ะะฐัะธะฝะฐะตะผ ัะฐะทะฒะตัััะฒะฐะฝะธะต Telegram ะฑะพัะฐ..."

# ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต ะฝะตะพะฑัะพะดะธะผัั ัะฐะนะปะพะฒ
if [ ! -f "telegramBot.py" ]; then
    echo "โ ะัะธะฑะบะฐ: ัะฐะนะป telegramBot.py ะฝะต ะฝะฐะนะดะตะฝ"
    exit 1
fi

if [ ! -f "requirements.txt" ]; then
    echo "โ ะัะธะฑะบะฐ: ัะฐะนะป requirements.txt ะฝะต ะฝะฐะนะดะตะฝ"
    exit 1
fi

# ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั
if [ -z "$VITE_TELEGRAM_TOKEN" ]; then
    echo "โ ะัะธะฑะบะฐ: ะฟะตัะตะผะตะฝะฝะฐั VITE_TELEGRAM_TOKEN ะฝะต ัััะฐะฝะพะฒะปะตะฝะฐ"
    exit 1
fi

echo "โ ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั ะฝะฐัััะพะตะฝั"

# ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ัััะตััะฒัััะธะน ะฟัะพัะตัั ะฑะพัะฐ
echo "๐ ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ัััะตััะฒัััะธะน ะฟัะพัะตัั ะฑะพัะฐ..."
pkill -f "python.*telegramBot.py" || echo "ะัะพัะตัั ะฝะต ะฝะฐะนะดะตะฝ"

# ะะดะตะผ ะทะฐะฒะตััะตะฝะธั ะฟัะพัะตััะฐ
sleep 3

# ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะทะฐะฒะธัะธะผะพััะธ
echo "๐ฆ ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะทะฐะฒะธัะธะผะพััะธ..."
pip install -r requirements.txt

# ะัะพะฒะตััะตะผ ัััะฐะฝะพะฒะบั
if [ $? -ne 0 ]; then
    echo "โ ะัะธะฑะบะฐ ะฟัะธ ัััะฐะฝะพะฒะบะต ะทะฐะฒะธัะธะผะพััะตะน"
    exit 1
fi

# ะะฐะฟััะบะฐะตะผ ะฑะพัะฐ ะฒ ัะพะฝะต
echo "๐ค ะะฐะฟััะบะฐะตะผ Telegram ะฑะพัะฐ..."
nohup python start_bot.py > bot.log 2>&1 &

# ะะดะตะผ ะฝะตะผะฝะพะณะพ ะดะปั ะทะฐะฟััะบะฐ
sleep 5

# ะัะพะฒะตััะตะผ, ััะพ ะฑะพั ะทะฐะฟัััะธะปัั
if pgrep -f "python.*telegramBot.py" > /dev/null; then
    echo "โ Telegram ะฑะพั ััะฟะตัะฝะพ ะทะฐะฟััะตะฝ!"
    echo "๐ ะะพะณะธ: tail -f bot.log"
    echo "๐ ะกัะฐััั: ./check_bot.sh"
else
    echo "โ ะัะธะฑะบะฐ: ะฑะพั ะฝะต ะทะฐะฟัััะธะปัั"
    echo "๐ ะัะพะฒะตัััะต ะปะพะณะธ: cat bot.log"
    exit 1
fi
